<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login e Registro</title>
  <link rel="stylesheet" href="login.css" /> </head>
<body>
  <div class="container">
    <button id="backButton">← Voltar</button>

    <div class="form-box" id="loginBox">
      <h2>Login</h2>
      <input type="text" id="loginPrincipal" placeholder="Usuário ou Email" />
      <input type="password" id="loginSenha" placeholder="Senha" />
      <button class="main-btn" id="loginBtn">Entrar</button>
      <p>Não tem conta? <span id="goRegister">Registrar</span></p>
      <div id="loginError" class="error hidden"></div>
    </div>

    <div class="form-box hidden" id="registerBox">
      <h2>Registro</h2>
      <div class="form-container">
        <label for="tipo">Você é:</label>
        <select id="tipo" onchange="mostrarCamposRegistro()">
          <option value="">Selecione...</option>
          <option value="paciente">Paciente</option>
          <option value="profissional">Profissional</option>
        </select>

        <div id="camposPaciente" class="hidden">
          <input type="text" id="regUsuario" placeholder="Nome de usuário" />
          <input type="email" id="regEmail" placeholder="Email" />
          <input type="password" id="regSenha" placeholder="Senha" />
        </div>

        <div id="camposProfissional" class="hidden">
          <input type="text" id="nomeProf" placeholder="Nome" />
          <input type="text" id="sobrenomeProf" placeholder="Sobrenome" />
          <input type="text" id="crmProf" placeholder="CRM (ex: 123456/SP)" />
          <input type="email" id="emailProf" placeholder="Email" />
          <input type="password" id="senhaProf" placeholder="Senha" /> 
        </div>

        <div id="registroError" class="error hidden"></div>
        <button id="btnRegistrar" class="main-btn">Registrar</button>
        <p>Já tem conta? <span id="goLogin">Voltar ao Login</span></p>
      </div>
    </div>
  </div>

  <script>
    // --- NAVEGAÇÃO ENTRE TELAS ---
    const loginBox = document.getElementById("loginBox");
    const registerBox = document.getElementById("registerBox");
    const goRegister = document.getElementById("goRegister");
    const goLogin = document.getElementById("goLogin");
    const backButton = document.getElementById("backButton");

    goRegister.addEventListener("click", () => {
      loginBox.classList.add("hidden");
      registerBox.classList.remove("hidden");
    });
    goLogin.addEventListener("click", () => {
      registerBox.classList.add("hidden");
      loginBox.classList.remove("hidden");
    });
    backButton.addEventListener("click", () => {
      registerBox.classList.add("hidden");
      loginBox.classList.remove("hidden");
    });

    function mostrarCamposRegistro() {
      const tipo = document.getElementById("tipo").value;
      const camposPaciente = document.getElementById("camposPaciente");
      const camposProfissional = document.getElementById("camposProfissional");
      camposPaciente.classList.add("hidden");
      camposProfissional.classList.add("hidden");
      if (tipo === "paciente") camposPaciente.classList.remove("hidden");
      else if (tipo === "profissional") camposProfissional.classList.remove("hidden");
    }

    // --- LÓGICA DE LOGIN (CONECTADA AO BACKEND) ---
    const loginBtn = document.getElementById("loginBtn");
    const loginError = document.getElementById("loginError");

    loginBtn.addEventListener("click", async () => {
      const login = document.getElementById("loginPrincipal").value; // Campo de login
      const password = document.getElementById("loginSenha").value;

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ login, password }) // Envia 'login' e 'password'
        });

        const data = await response.json(); 
        if (!response.ok) {
          loginError.textContent = data.error;
          loginError.classList.remove("hidden");
        } else {
          loginError.classList.add("hidden");
          sessionStorage.setItem('userData', JSON.stringify(data)); // Salva o usuário

          // Lógica de Redirecionamento
          if (data.tipo === 'paciente') {
            if (data.pre_diagnostico === null) {
              alert(`Bem-vindo(a) ${data.username}! Responda umas perguntas rápidas.`);
              window.location.href = '/questionario.html';
            } else {
              window.location.href = '/paginaPaciente.html'; // Mude se o nome for outro
            }
          } else if (data.tipo === 'profissional') {
            alert(`Bem-vindo(a) ${data.username}!`);
            window.location.href = "/profissional.html";
          }
        }
      } catch (err) {
        loginError.textContent = "Erro de conexão com o servidor.";
        loginError.classList.remove("hidden");
      }
    });

    // --- LÓGICA DE REGISTRO (CONECTADA AO BACKEND) ---
    const btnRegistrar = document.getElementById("btnRegistrar");
    const registroError = document.getElementById("registroError");

    btnRegistrar.addEventListener("click", async () => {
      const tipo = document.getElementById("tipo").value;
      let bodyData = { tipo: tipo };
      registroError.classList.add("hidden");

      if (tipo === "paciente") {
        bodyData.username = document.getElementById("regUsuario").value;
        bodyData.password = document.getElementById("regSenha").value;
        bodyData.email = document.getElementById("regEmail").value;

        if (!bodyData.username || !bodyData.password || !bodyData.email) {
          registroError.textContent = "Preencha todos os campos!";
          registroError.classList.remove("hidden");
          return;
        }
      } else if (tipo === "profissional") {
        bodyData.nome_completo = document.getElementById("nomeProf").value + " " + document.getElementById("sobrenomeProf").value;
        bodyData.crm = document.getElementById("crmProf").value;
        bodyData.email = document.getElementById("emailProf").value;
        bodyData.password = document.getElementById("senhaProf").value;

        if (!bodyData.nome_completo || !bodyData.crm || !bodyData.email || !bodyData.password) {
          registroError.textContent = "Preencha todos os campos!";
          registroError.classList.remove("hidden");
          return;
        }
      } else {
        registroError.textContent = "Selecione um tipo válido!";
        registroError.classList.remove("hidden");
        return;
      }

      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyData)
        });

        const data = await response.json();
        if (!response.ok) {
          registroError.textContent = data.error; 
          registroError.classList.remove("hidden");
        } else {
          alert("Registrado com sucesso! Por favor, faça o login.");
          registerBox.classList.add("hidden");
          loginBox.classList.remove("hidden");
        }
      } catch (err) {
        registroError.textContent = "Erro de conexão com o servidor.";
        registroError.classList.remove("hidden");
      }
    });
  </script>
</body>
</html>
 